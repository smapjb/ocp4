- name: This playbook installs and configures haproxy
  hosts: haproxy
  become: yes
  gather_facts: false

  tasks:

    - name: Ensure HAProxy is installed (RedHat).
      yum: name=haproxy state=installed
    
    - name: Ensure Firewalld is installed (RedHat).
      yum: name=firewalld state=installed

    - name: Copy HAProxy configuration in place.
      template:
        src: haproxy.cfg.j2
        dest: /etc/haproxy/haproxy.cfg
        mode: 0644
        validate: haproxy -f %s -c -q
      notify: restart haproxy

    - name: Enable selinux policy for the ports
      seport:
        ports: 1936, 6443, 22623, 80, 443
        proto: tcp
        setype: http_port_t
        state: present
    
    - name: Ensure Firewalld is started and enabled on boot.
      service: name=firewalld state=started enabled=yes

    - name: Open up the firewall for the stats service
      firewalld:
        port: "{{ item }}/tcp"
        permanent: true
        immediate: yes
        state: enabled
      with_items:
        - 1936
        - 6443
        - 22623
        - 80
        - 443

    - name: Ensure HAProxy is started and enabled on boot.
      service: name=haproxy state=started enabled=yes

  handlers:
     - name: restart haproxy
       service: name=haproxy state=restarted


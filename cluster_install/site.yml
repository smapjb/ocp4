---
- name: This is a playbook for cloning a vm in RHEV
  hosts: localhost
  gather_facts: False

  roles:
    - pre_install

    - role: provision
      host_memory: 2
      sockets: 1
      node_type: haproxy
      machine_type: rhel
      hostname_prefix:
        - haproxy
        - api
        - api-int

    - role: provision
      host_memory: 16
      sockets: 4
      disk_size: 8
      node_type: bootstrap
      machine_type: rhcos
      hostname_prefix:
        - bootstrap

    - role: provision
      host_memory: 16
      sockets: 4
      disk_size: 8
      node_type: master
      machine_type: rhcos
      hostname_prefix:
        - master00
        - etcd-0

    - role: provision
      host_memory: 16
      sockets: 4
      disk_size: 8
      node_type: master
      machine_type: rhcos
      hostname_prefix:
        - master01
        - etcd-1

    - role: provision
      host_memory: 16
      sockets: 4
      disk_size: 8
      node_type: master
      machine_type: rhcos
      hostname_prefix:
        - master02
        - etcd-2

    - role: provision
      host_memory: 8
      sockets: 2
      disk_size: 8
      node_type: worker
      machine_type: rhcos
      hostname_prefix:
        - worker01

    - role: provision
      host_memory: 8
      sockets: 2
      disk_size: 8
      node_type: worker
      machine_type: rhcos
      hostname_prefix:
        - worker02

    - role: provision
      host_memory: 8
      sockets: 2
      disk_size: 8
      node_type: worker
      machine_type: rhcos
      hostname_prefix:
        - worker03


- name: Configure haproxy
  hosts: "haproxy.{{ cluster_name }}.internal.croftvillas.com"
  remote_user: root

  roles:
    - haproxy_configure

- name: Run the installer against the bootstrap
  hosts: localhost
  gather_facts: False

  tasks:
    - name: Peform the installation
      command: "./openshift-install --dir={{ cluster_name }} wait-for bootstrap-complete --log-level debug"



- name: This playbook installs the guest agent on rhcos nodes
  hosts: worker:master:!bootstrap
  remote_user: core
  become: true

  vars:
    guest_agent: "http://rpmfind.net/linux/centos/7.6.1810/os/x86_64/Packages/qemu-guest-agent-2.12.0-2.el7.x86_64.rpm"

  tasks:
    - name: Install the guest agent on the new node
      command: "rpm-ostree install --idempotent {{ guest_agent }}"

    - name: Reboot new host
      reboot:


